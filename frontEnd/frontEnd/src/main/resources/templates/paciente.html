<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<title>Front End Paciente</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<style>
    body {
        background-color: #f4f9ff; /* Azul bem claro */
        font-family: Arial, Helvetica, sans-serif;
        margin: 20px;
        color: #1a3d5c; /* Azul escuro elegante */
    }

    h1, h3 {
        color: #0f4c75; /* Azul clínico */
    }

    table {
        background: white;
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
    }

    table th {
        background-color: #0f4c75; /* Azul hospitalar */
        color: white;
        padding: 8px;
        border: 1px solid #cccccc;
        text-align: left;
    }

    table td {
        padding: 8px;
        border: 1px solid #cccccc;
        background-color: #ffffff;
    }

    input[type="text"] {
        width: 90%;
        padding: 6px;
        border: 1px solid #8db5c9;
        border-radius: 4px;
        background-color: #ffffff;
    }

    button, #buttonAtualizar{
        background-color: #1b9aaa; /* Verde-azulado médico */
        color: white;
        padding: 8px 14px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 5px;
        transition: 0.3s;
		margin-top: 8px;
    }
	

    button:hover {
        background-color: #157a82; /* Tom mais escuro no hover */
    }

    #listaPacientes {
        margin-top: 20px;
    }
</style>
</head>
<body>

<h1>FRONT-END PACIENTE</h1>

<h3>Cadastro de Paciente</h3>


<table>
<tr>
	<td> Nome: </td>
   	<td><input type="text" id="nome" size="50" ><br></td>
</tr>
<tr>
	<td>CPF: </td>
  	<td><input type="text" id="cpf" size="50"><br></td>
</tr>
<tr>
  	<td>Telefone:</td>
   	<td><input type="text" id="telefone" size="20"> <br></td>
</tr>
<tr>
  	<td>Data de Nascimento: </td>
  	<td><input type="text" id="dataNascimento" size="50"><br></td>
</tr>
<tr>
  	<td>Genero: </td>
  	<td><input type="text" id="genero" size="50"><br></td>
</tr>
	<tr>
	  	<td>Email: </td>
	  	<td><input type="text" id="email" size="50"><br></td>
	</tr>
</table>  
        
  <button onclick="criarPaciente()">Adicionar</button>

   <h3>Listagem de Paciente </h3>
  <div id="listaPacientes"></div> 
  
</body>

</html>


<script type="text/javascript">

const urlAPI = "http://localhost:9003/v1/paciente"; // URL da API pacienteServices

// Função para criar um novo paciente
async function criarPaciente() {
  
	// pega os dados da tela.
	const nome = document.getElementById("nome").value;
	const cpf = document.getElementById("cpf").value;
  	const telefone = document.getElementById("telefone").value;
  	const dataNascimento = document.getElementById("dataNascimento").value;
	const genero = document.getElementById("genero").value;
	const email = document.getElementById("email").value;
  
  // cria o payload para enviar a api.
	const body = {
		"nome" : nome,
		"cpf" : cpf,
		"telefone" : telefone,
		"dataNascimento" : dataNascimento,
		"genero" : genero,
		"email" : email
 	}
  // realiza a chamada na api
  	await fetch(urlAPI, {
    	method: "POST",
    	headers: {
      	"Content-Type": "application/json"
    	},
    	body: JSON.stringify( body )
  	}).then(response =>{
		// trata o status de sucesso.		
	  	if(response.status == 200){	  		
			alert("sucesso no cadastro do paciente");
			document.getElementById("nome").value = "";
			document.getElementById("cpf").value = "";
			document.getElementById("telefone").value = "";
			document.getElementById("dataNascimento").value = "";
			document.getElementById("genero").value = "";
			document.getElementById("email").value = "";
		}else{
			// trata o erro no cadastro.
			const data = response.text().then(d => {
				alert("Erro no cadastro \n" + d);
			});

		}	  
 	 })
  ;
  
  	carregarPacientes(); // Atualiza a lista de pacientes
}

//Função para carregar os pacientes 
async function carregarPacientes() {

	// realiza a chamda na api
	const response = await fetch(urlAPI);
  	// transforma os dados da api para paciente (json-> objeto)
	const pacientes = await response.json();

  	const listaPacientes = document.getElementById("listaPacientes");
 	listaPacientes.innerHTML = ""; // Limpa a lista antes de adicionar as tarefas
 	
 	if(pacientes == ""){
 		listaPacientes.innerHTML = `Nenhum paciente cadastrado
 			<br><br>
 			<input id='buttonAtualizar' type='button' onclick='carregarPacientes()' value='Atualizar'/>
 		`;
 		return;
 	}
  
 	var linhas = `<tr>
		<th>Nome</th>
		<th>CPF</th>
		<th>Telefone</th>
		<th>Data de Nascimento</th>
		<th>Genero</th>
		<th>Email</th>
		<th>Ação</th>`;
  	// vai iterando cada paciente.
 	pacientes.forEach(paciente => {    
	  linha = `
    	<tr>
    		<td>${paciente.nome}</td>
    		<td>${paciente.cpf}</td>
    		<td>${paciente.telefone} </td>
    		<td>${paciente.dataNascimento}</td>
			<td>${paciente.genero} </td>
			<td>${paciente.email} </td>
    		<td>
    			<button onclick="editarPaciente(${paciente.id})">Editar</button>
      			<button onclick="excluirPaciente(${paciente.id},'${paciente.nome}')">Excluir</button>
      		</td>    
    	`;
	  	linhas = linhas + linha;
  	});
  
  	listaPacientes.innerHTML  =  '<table border=1>' + linhas + '</table><br>'  +
  		"<input id='buttonAtualizar' type='button' onclick='carregarPacientes()' value='Atualizar'/>";  
}

// Função para excluir um paciente
async function excluirPaciente(id,nome) {
 	if (confirm("Deseja excluir o paciente " + nome + " ?")) {
    	await fetch(`${urlAPI}/${id}`, {
      	method: "DELETE"
    	});

	carregarPacientes(); 
  }
 
}


// Variável global para armazenar o ID do paciente que está sendo editado
let pacienteEmEdicao = null;

// Função para editar um paciente
async function editarPaciente(id) {

    // Buscar o paciente pelo ID (GET /v1/paciente/buscar-paciente/{id})
    const response = await fetch(`${urlAPI}/buscar-paciente/${id}`);
    const paciente = await response.json();

    // Preenche os campos da tela com os dados do paciente
    document.getElementById("nome").value = paciente.nome;
    document.getElementById("cpf").value = paciente.cpf;
    document.getElementById("telefone").value = paciente.telefone;
    document.getElementById("dataNascimento").value = paciente.dataNascimento;
    document.getElementById("genero").value = paciente.genero;
    document.getElementById("email").value = paciente.email;

    // Guarda o ID do paciente que está sendo editado
    pacienteEmEdicao = paciente.id;

    // Altera o botão principal para "Salvar Alterações"
    const botao = document.querySelector("button[onclick='criarPaciente()']");
    botao.innerText = "Salvar Edição";
    botao.onclick = salvarEdicaoPaciente;
}

// Função que envia os dados editados ao back-end
async function salvarEdicaoPaciente() {

    if (!pacienteEmEdicao) {
        alert("Nenhum paciente selecionado para edição.");
        return;
    }

    // Captura os dados atualizados da tela
    const body = {
        id: pacienteEmEdicao,
        nome: document.getElementById("nome").value,
        cpf: document.getElementById("cpf").value,
        telefone: document.getElementById("telefone").value,
        dataNascimento: document.getElementById("dataNascimento").value,
        genero: document.getElementById("genero").value
        genero: document.getElementById("email").value
    };

    // Faz o PUT enviando o id dentro do JSON
    const response = await fetch(urlAPI, {
        method: "PUT",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
    });

    if (response.status === 200) {
        alert("Paciente atualizado com sucesso!");
    } else {
        const erro = await response.text();
        alert("Erro ao atualizar paciente:\n" + erro);
    }

    // Limpa formulario
    document.getElementById("nome").value = "";
    document.getElementById("cpf").value = "";
    document.getElementById("telefone").value = "";
    document.getElementById("dataNascimento").value = "";
    document.getElementById("genero").value = "";
    document.getElementById("email").value = "";

    // Volta o botão ao modo original
    const botao = document.querySelector("button[onclick='salvarEdicaoPaciente()']");
    botao.innerText = "Adicionar";
    botao.onclick = criarPaciente;

    pacienteEmEdicao = null;

    carregarPacientes();
}

carregarPacientes();


</script>